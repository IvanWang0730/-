<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title></title>
		<style>
			body {
				background-color: lightpink;
			}
			
			#SVG{
				background-color: floralwhite;
			}
			
			.textblock{
				border:1px solid black;
				width:300px;
				border-radius:10px;
				overflow-x: hidden;
				background-color: floralwhite;
				
			}
			
			.textblock::-webkit-scrollbar {/*滚动条整体样式*/
				width: 20px;     /*高宽分别对应横竖滚动条的尺寸*/
				height: 4px;
				scrollbar-arrow-color:red;
			 }
			.textblock::-webkit-scrollbar-thumb {/*滚动条里面小方块*/
				border-radius: 5px;
				-webkit-box-shadow: inset 0 0 5px rgba(0,0,0,0.2);
				background: rgba(0,0,0,0.2);
				scrollbar-arrow-color:red;
			}
			.textblock::-webkit-scrollbar-track {/*滚动条里面轨道*/
				-webkit-box-shadow: inset 0 0 5px rgba(0,0,0,0.2);
				border-radius: 0;
				background: rgba(0,0,0,0.1);
			}
			
			.container{
				border:1px solid black;
				width:250px;
				border-radius:10px;
				margin:20px 20px 20px 15px;
				max-width: 250px;
				box-shadow:1px 2px 3px 4px #adadad;
				overflow: hidden;
			}
			
			.text{
				margin:10px;
				font-size:25px;
			}
			
			.time{
				margin:10px;
				color:dimgray;
				font-size:20px;
			}
			
			.author{
				color:#f4606c;
			}
			
			.tags{
				color:#55aaff;
			}
			
			/* 提示框 */
			.tooltip {
			  position: absolute;
			  padding: 7px;
			  font-size: 1.5em;
			  pointer-events: none;
			  background: #fff;
			  border: 1px solid #ccc;
			  border-radius: 4px;
			
			  /* 添加阴影效果 */
			  -moz-box-shadow:    3px 3px 10px 0px rgba(0, 0, 0, 0.25);
			  -webkit-box-shadow: 3px 3px 10px 0px rgba(0, 0, 0, 0.25);
			  box-shadow:         3px 3px 10px 0px rgba(0, 0, 0, 0.25);
			}
			
			.tooltip p {
			  margin: 0;
			  padding: 0;
			}
			
			.tooltip table {
			  margin: 0;
			  padding: 0;
			  border-collapse: collapse;
			}
			
			
		</style>
		<script src="https://d3js.org/d3.v7.min.js"></script>
		<script src="https://unpkg.com/topojson-client@3"></script>
		<script src="d3-cloud-master\build\d3.layout.cloud.js"></script>
	</head>
	<body>
		<svg id="SVG"></svg>
		<canvas id="CANVAS"></canvas>
		<script>
			const width = 2400
			const height = 1200
			const margin = 70
			
			const svg = d3.select("#SVG")
					.attr("width", width)
					.attr("height", height)
					.attr('transform', `translate(${margin}, ${margin})`);
			
			d3.json("Abila.json").then(function (data){
				const map = svg.append("g").attr("transform", `translate(${5*margin}, ${2.5*margin})`)
				
				const projection = d3.geoMercator()
				const pathGenerator = d3.geoPath().projection(projection);
				
				worldmeta = topojson.feature(data, data.objects.Abila);
				console.log(worldmeta.features)
				projection.fitSize([width/2-1*margin, height/2-1*margin], worldmeta);
				
				const paths = map.selectAll('path')
					.data(worldmeta.features, d => d.properties.FENAME)
					.enter().append('path')
					.attr('d', pathGenerator)
					.attr('stroke', 'black')
					.attr('stroke-width', 1)
					.attr("fill", "none");
				
				const arc = d3.arc()
					.innerRadius(height/3+margin/2)
					.outerRadius(width)
					.startAngle(0)
					.endAngle(2*Math.PI)
					.padAngle(0.0);
					
				map.append("g")
					.append("path")
					.attr("d", arc)
					.attr("fill", "floralwhite")
					.attr("stroke-width", "1px")
					.attr("stroke", "#000002")
					.attr("transform", `translate(${7.9*margin}, ${4.4*margin})`);
					
				d3.json("mbdata.json").then(function (mbdata){
					d3.json("ccdata.json").then(function (ccdata){
						console.log(mbdata)
						console.log(ccdata)
						
						const arc2 = d3.arc()
							.innerRadius(height/3+margin/2)
							.outerRadius(d => height/3+margin/2+d.cnt/d3.max(mbdata.Relevant, d=>d.cnt)*100)
							.startAngle((d,i) => i*2*Math.PI/2137)
							.endAngle((d,i) => (i+1)*2*Math.PI/2137);
							
						const arcs2 = map.append("g")
							.selectAll()
							.data(mbdata.Relevant).enter()
							.append("path")
							.attr("d", arc2)
							.attr("fill", "white")
							.attr("stroke-width", "0.0px")
							.attr("stroke", "#000002")
							.attr("transform", `translate(${7.9*margin}, ${4.4*margin})`)
							.on("mouseover", function (event, d){
								tooltip.transition()
									.duration(250) // 设置transition效果的速度，默认为500ms
									.style("opacity", 1);
								
								tooltip.html(
										"<p><b>" + "Positive Rate" + "</b></p>"
									)
									.style("left", (event.pageX + 15) + "px")
									.style("top", (event.pageY - 28) + "px");
							})
							.on("mouseout", function (){
								tooltip.transition()
									.duration(250)
									.style("opacity", 0);
							});
						
						const brushmap = svg.append("g");
						
						const scaleX = d3.scaleTime()
							.domain([d3.min(mbdata.Relevant, d=>new Date(d.date)), d3.max(mbdata.Relevant, d=>new Date(d.date))])
							.range([0, width]);
						const [x0, x1] = [d3.min(mbdata.Relevant, d=>new Date(d.date)), d3.max(mbdata.Relevant, d=>new Date(d.date))]
						const axisX = d3.axisBottom(scaleX)
										.ticks(10)
										.tickFormat(d3.timeFormat('%H:%M'))
										.tickSize(10);
						brushmap.append("g").call(axisX)
								.attr("transform", `translate(${0}, ${height-margin})`)
								.selectAll("text").style("font-size", "20px") 
						
						const scaleY = d3.scaleLinear()
							.domain([0, d3.max(mbdata.Relevant, d=>d.cnt)])
							.range([height-margin, height-3*margin])
							
						const AreaGenerator = d3.area().curve(d3.curveBasis)
									.x(d => scaleX(new Date(d.date)))
									.y0(d => scaleY(0))
									.y1(d => scaleY(d.cnt));
						const mbarea = brushmap.append("g").data(mbdata.Relevant)
							.append("path")
							.attr("d", AreaGenerator(mbdata.Relevant))
							.attr("fill", "#f4606c")
							.attr("stroke-width", "1.5px")
							.attr("stroke", "none")
							.attr("class", "mbarea")
							// .on("mouseover", function(){
							// 	d3.selectAll(".mbarea").attr("stroke", "#f4606c")
							// })
							// .on("mouseout", function(){
							// 	d3.selectAll(".mbarea").attr("stroke", "none")
							// });
						const ccarea = brushmap.append("g").data(ccdata)
							.append("path")
							.attr("d", AreaGenerator(ccdata))
							.attr("fill", "#ffaa7f")
							.attr("stroke-width", "1.5px")
							.attr("stroke", "none")
							.attr("class", "ccarea")
							// .on("mouseover", function(){
							// 	d3.selectAll(".ccarea").attr("stroke", "#ffaa7f")
							// })
							// .on("mouseout", function(){
							// 	d3.selectAll(".ccarea").attr("stroke", "none")
							// });
						
						// Legend
						brushmap.append("circle").attr("r", 10).attr("fill", "#f4606c")
								.attr("cx", 5*margin).attr("cy", height-2*margin)
						brushmap.append("text").text("mbdata")
							.attr("transform", `translate(${5*margin+10}, ${height-2*margin+5})`)
						brushmap.append("circle").attr("r", 10).attr("fill", "#ffaa7f")
								.attr("cx", 5*margin+100).attr("cy", height-2*margin)
						brushmap.append("text").text("ccdata")
							.attr("transform", `translate(${5*margin+110}, ${height-2*margin+5})`)
							
							
						let tooltip = d3.select("body").append("div")
							.attr("class", "tooltip")
							.style("opacity", 0);
						
						const cccircle = map.append("g")
							.selectAll()
							.data(ccdata).enter()
							.append("circle")
							.attr("cx", d => projection([d.longitude,d.latitude])[0])
							.attr("cy", d => projection([d.longitude,d.latitude])[1])
							.attr("r", 5)
							.attr("fill", "#f4606c")
							.on("mouseover", function (event, d){
								d3.select(this).attr("r", 7)
								.attr("stroke-width", "3.5px");
								
								tooltip.transition()
									.duration(250) // 设置transition效果的速度，默认为500ms
									.style("opacity", 1);
								
								tooltip.html(
										"<p><b>" + d.time + "</b></p>" +
										"<tr><td>Location:</td><td>" + d.location + "</td></tr>" + 
										"<table><tbody><tr><td class='wide'>Message:</td><td>" + d.message + "</td></tr>"
									)
									.style("left", (event.pageX + 15) + "px")
									.style("top", (event.pageY - 28) + "px");
							})
							.on("mouseout", function (){
								d3.select(this).attr("r", 5);
								
								tooltip.transition()
									.duration(250)
									.style("opacity", 0);
							});
						
						const circle = map.append("g")
							.selectAll()
							.data(mbdata.Relevant).enter()
							.append("circle")
							.attr("cx", d => projection([d.longitude,d.latitude])[0])
							.attr("cy", d => projection([d.longitude,d.latitude])[1])
							.attr("r", 20)
							.attr("opacity", 0.5)
							.attr("fill", "#ffaa00")
							.attr("class", (d, i)=>"graph"+i)
							.attr("title", d=>d.message)
							.on("mouseover", function (event, d){
								d3.select(this).attr('stroke', "black")
								.attr("stroke-width", "3.5px")
								
								tooltip.transition()
									.duration(250) // 设置transition效果的速度，默认为500ms
									.style("opacity", 1);
								
								tooltip.html(
										"<p><b>" + d.time + "</b></p>" +
										"<tr><td>Author:</td><td>" + d.author + "</td></tr>" + 
										"<table><tbody><tr><td class='wide'>Message:</td><td>" + d.message + "</td></tr>"
									)
									.style("left", (event.pageX + 15) + "px")
									.style("top", (event.pageY - 28) + "px");
							})
							.on("mouseout", function (){
								d3.select(this).attr('stroke', "none")
								
								tooltip.transition()
									.duration(250)
									.style("opacity", 0);
							});
							
						const brush = d3.brushX()
						    .extent([[0, height-margin], [width, height]])
						    .on("start brush end", brushed);
						
						svg.append("g")
						    .call(brush)
						    .call(brush.move, [3, 5].map(scaleX))
							.on("dblclick", dblclicked);
							
						function dblclicked() {
							const selection = d3.brushSelection(this) ? null : scaleX.range();
							d3.select(this).call(brush.move, selection);
							circle.attr("cx", d => projection([d.longitude,d.latitude])[0])
								.attr("cy", d => projection([d.longitude,d.latitude])[1])
						};
						
						function brushed({selection}){
							if (selection === null) {
								// circle.attr("r", 0);
							} else {
								const [x0, x1] = selection.map(scaleX.invert);
								circle.attr("r", d => x0 <= new Date(d.date) && new Date(d.date) <= x1 ? 20:0)
								cccircle.attr("r", d => x0 <= new Date(d.date) && new Date(d.date) <= x1 ? 5:0)
								arcs2.attr("fill", d => x0 <= new Date(d.date) && new Date(d.date) <= x1 ? "#8cc7b5":"gray")

								d3.selectAll(".container").remove()
								
								for (var choice of ["Relevant", "Chatter", "Spam"]){
									var new_choice_mbdata = new Array()
									for (let item of mbdata[choice]){
										if (x0 <= new Date(item.date) && new Date(item.date) <= x1){
											new_choice_mbdata.push(item)
										}
									}
									var container = d3.select("#"+choice+"block")
										.selectAll(".container").data(new_choice_mbdata).enter()
										.append("div")
										.attr("class", "container")
										.attr("id", "container_"+choice)
									container.append("p").text(d=>d.time).attr("class", "time")
									var text = container.append('p')
									    .attr('class', 'text')
									text.append("span")
										.text(d=>d.author+": ")
										.attr("class", "author")
									text.append("span")
										.text(d=>d.rt)
										.attr("class", "tags")
									text.append("span")
										.text(d=>d.message)
									text.append("span")
										.text(d=>d.tags)
										.attr("class", "tags")
								}
								
								var new_ccdata = new Array()
								for (let item of ccdata){
									if (x0 <= new Date(item.date) && new Date(item.date) <= x1){
										new_ccdata.push(item)
									}
								}
								var container = d3.select("#ccblock")
									.selectAll('.container').data(new_ccdata).enter()
									.append('div')
									.attr('class', 'container')
									.attr("id", "container_cc")
								container.append("p").text(d=>d.time).attr("class", "time")
								var text = container.append('p')
								    .attr('class', 'text')
								text.append("span")
									.text(d=>d.location !== 0 ? d.location+": " : "")
									.attr("class", "author")
								text.append("span")
									.text(d=>d.message)
									
								d3.selectAll("#cloud").remove()
								
								var worddict = {}
								for (let item of mbdata.Relevant){
									for (let key in item.tfidf){
										if (x0 <= new Date(item.date) && new Date(item.date) <= x1){
											if (key in worddict){
												worddict[key] += item.tfidf[key]
											} else {
												worddict[key] = item.tfidf[key]
											}
										}
									}
								}
								var res = Object.keys(worddict).sort(function(a,b){return -worddict[a]+worddict[b];})
								words = new Array()
								var n = 0
								for (let word of res){
									if (n>50){break}
									words.push({"text":word, "size":10+100*worddict[word]/d3.max(Object.values(worddict),d=>d)})
									n += 1
								}
								
								d3.layout.cloud().size([900, 300])
								.words(words)
								.rotate(function() { return ~~(Math.random() * 2) * 90; })
								        .font("Impact")
								        .fontSize(function(d) { return d.size; })
								        .on("end", draw)//结束时运行draw函数
								        .start();
										
								function draw(words) {
									d3.select("svg").append("g").attr("id", "cloud")
										.attr("style", "border:1px solid red")
										.attr("transform", `translate(${width-6.5*margin},${height-4.5*margin})`)
										.selectAll("text")
										.data(words)
										.enter().append("text")
										.style("border","1px solid blue")
										.style("font-size", function(d) { return d.size + "px"; })
										.style("font-family", "Impact")
										.style("fill", function(d, i) { return fill(i); })//fill 在前面15行定义为颜色集
										.attr("text-anchor", "middle")
										.attr("class", "keyword")
										.attr("id", d=>d.text)
										.attr("transform", function(d) {
											return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
										})
										.text(function(d) { return d.text; })
										.on("click", function (){
											if (d3.select(this).attr("opacity")==0.9){
												d3.selectAll(".keyword").attr("opacity", 1)
												
												d3.selectAll("#container_Relevant").remove()
												key_mbdata = new Array()
												for (let item of mbdata["Relevant"]){
													if (x0 <= new Date(item.date) && new Date(item.date) <= x1){
														key_mbdata.push(item)
													}
												}
												var container = d3.select("#Relevantblock")
													.selectAll(".container").data(key_mbdata).enter()
													.append("div")
													.attr("class", "container")
													.attr("id", "container_Relevant")
												container.append("p").text(d=>d.time).attr("class", "time")
												var text = container.append('p')
													.attr('class', 'text')
												text.append("span")
													.text(d=>d.author+": ")
													.attr("class", "author")
												text.append("span")
													.text(d=>d.rt)
													.attr("class", "tags")
												text.append("span")
													.text(d=>d.message)
												text.append("span")
													.text(d=>d.tags)
													.attr("class", "tags")
											} else {
												d3.selectAll(".keyword").attr("opacity", 0.3)
												d3.select(this).attr("opacity", 0.9)
												
												console.log(d3.select(this).attr("id"))
												
												d3.selectAll("#container_Relevant").remove()
												key_mbdata = new Array()
												for (let item of mbdata["Relevant"]){
													if (x0 <= new Date(item.date) && new Date(item.date) <= x1 && item.message.toLowerCase().indexOf(d3.select(this).attr("id")) !== -1){
														key_mbdata.push(item)
													}
												}
												var container = d3.select("#Relevantblock")
													.selectAll(".container").data(key_mbdata).enter()
													.append("div")
													.attr("class", "container")
													.attr("id", "container_Relevant")
												container.append("p").text(d=>d.time).attr("class", "time")
												var text = container.append('p')
													.attr('class', 'text')
												text.append("span")
													.text(d=>d.author+": ")
													.attr("class", "author")
												text.append("span")
													.text(d=>d.rt)
													.attr("class", "tags")
												text.append("span")
													.text(d=>d.message)
												text.append("span")
													.text(d=>d.tags)
													.attr("class", "tags")
											}
										});
								}
							};
						};
						
						for (let choice of ["Relevant", "Chatter", "Spam"]){
							var container = d3.select("#"+choice+"block")
								.selectAll('.container').data(mbdata[choice]).enter()
								.append('div')
								.attr('class', 'container')
								.attr("id", "container_"+choice)
							container.append("p").text(d=>d.time).attr("class", "time")
							var text = container.append('p')
							    .attr('class', 'text')
							text.append("span")
								.text(d=>d.author+": ")
								.attr("class", "author")
							text.append("span")
								.text(d=>d.rt)
								.attr("class", "tags")
							text.append("span")
								.text(d=>d.message)
							text.append("span")
								.text(d=>d.tags)
								.attr("class", "tags")
						}
						
						var container = d3.select("#ccblock")
							.selectAll('.container').data(ccdata).enter()
							.append('div')
							.attr('class', 'container')
							.attr("id", "container_cc")
						container.append("p").text(d=>d.time).attr("class", "time")
						var text = container.append('p')
						    .attr('class', 'text')
						text.append("span")
							.text(d=>d.location !== 0 ? d.location+": " : "")
							.attr("class", "author")
						text.append("span")
							.text(d=>d.message)
						
						var worddict = {}
						for (let item of mbdata.Relevant){
							for (let key in item.tfidf){
								if (key in worddict){
									worddict[key] += item.tfidf[key]
								} else {
									worddict[key] = item.tfidf[key]
								}
							}
						}
						var res = Object.keys(worddict).sort(function(a,b){return -worddict[a]+worddict[b];})
						words = new Array()
						var n = 0
						for (let word of res){
							if (n>50){break}
							words.push({"text":word, "size":10+worddict[word]})
							n += 1
						}
						
						var fill = d3.scaleOrdinal(d3.schemeCategory10);
						d3.layout.cloud().size([900, 300])
						.words(words)
						.rotate(function() { return ~~(Math.random() * 2) * 90; })
						        .font("Impact")
						        .fontSize(function(d) { return d.size; })
						        .on("end", draw)//结束时运行draw函数
						        .start();
						function draw(words) {
							d3.select("svg").append("g").attr("id", "cloud")
								.attr("style", "border:1px solid red")
								.attr("transform", `translate(${width-6.5*margin},${height-4.5*margin})`)
								.selectAll("text")
								.data(words)
								.enter().append("text")
								.style("border","1px solid blue")
								.style("font-size", function(d) { return d.size + "px"; })
								.style("font-family", "Impact")
								.style("fill", function(d, i) { return fill(i); })//fill 在前面15行定义为颜色集
								.attr("text-anchor", "middle")
								.attr("class", "keyword")
								.attr("id", d=>d.text)
								.attr("transform", function(d) {
									return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
								})
								.text(function(d) { return d.text; })
								.on("click", function (){
									if (d3.select(this).attr("opacity")==0.9){
										d3.selectAll(".keyword").attr("opacity", 1)
										
										d3.selectAll("#container_Relevant").remove()
										key_mbdata = new Array()
										for (let item of mbdata["Relevant"]){
											if (x0 <= new Date(item.date) && new Date(item.date) <= x1){
												key_mbdata.push(item)
											}
										}
										var container = d3.select("#Relevantblock")
											.selectAll(".container").data(key_mbdata).enter()
											.append("div")
											.attr("class", "container")
											.attr("id", "container_Relevant")
										container.append("p").text(d=>d.time).attr("class", "time")
										var text = container.append('p')
											.attr('class', 'text')
										text.append("span")
											.text(d=>d.author+": ")
											.attr("class", "author")
										text.append("span")
											.text(d=>d.rt)
											.attr("class", "tags")
										text.append("span")
											.text(d=>d.message)
										text.append("span")
											.text(d=>d.tags)
											.attr("class", "tags")
									} else {
										d3.selectAll(".keyword").attr("opacity", 0.3)
										d3.select(this).attr("opacity", 0.9)
										
										console.log(d3.select(this).attr("id"))
										
										d3.selectAll("#container_Relevant").remove()
										key_mbdata = new Array()
										for (let item of mbdata["Relevant"]){
											if (x0 <= new Date(item.date) && new Date(item.date) <= x1 && item.message.toLowerCase().indexOf(d3.select(this).attr("id")) !== -1){
												key_mbdata.push(item)
											}
										}
										var container = d3.select("#Relevantblock")
											.selectAll(".container").data(key_mbdata).enter()
											.append("div")
											.attr("class", "container")
											.attr("id", "container_Relevant")
										container.append("p").text(d=>d.time).attr("class", "time")
										var text = container.append('p')
											.attr('class', 'text')
										text.append("span")
											.text(d=>d.author+": ")
											.attr("class", "author")
										text.append("span")
											.text(d=>d.rt)
											.attr("class", "tags")
										text.append("span")
											.text(d=>d.message)
										text.append("span")
											.text(d=>d.tags)
											.attr("class", "tags")
									}
								});
						}
					})
				})
			})
			
			
		</script>
		<form name="relevant" action="" method="" style="position:absolute;top:80px;left:1575px;">
		<div id="Relevantblock" class="textblock" style="width: 300px;height: 700px;">
			<p align="middle" style="font-weight:bold;font-size:20pt;">Relevant</p>
		</div>
		</form>
		<form name="chatter" action="" method=""  style="position:absolute;top:80px;left:1875px;">
		<div id="Chatterblock" class="textblock" style="width: 300px;height: 700px;">
			<p align="middle" style="font-weight:bold;font-size:20pt;">Chatter</p>
		</div>
		</form>
		<form name="spam" action="" method=""  style="position:absolute;top:80px;left:2175px;">
		<div id="Spamblock" class="textblock" style="width: 300px;height: 700px;">
			<p align="middle" style="font-weight:bold;font-size:20pt;">Spam</p>
		</div>
		</form>
		<form name="cc" action="" method=""  style="position:absolute;top:80px;left:80px;">
		<div id="ccblock" class="textblock" style="width: 300px;height: 900px;">
			<p align="middle" style="font-weight:bold;font-size:20pt;">ccdata</p>
		</div>
		</form>
	</body>
</html>
